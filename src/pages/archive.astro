---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';

const allPosts = await getCollection('blog');
const sortedPosts = allPosts.sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

// Group posts by year and month
const postsByYearMonth = new Map();

sortedPosts.forEach(post => {
  const year = post.data.pubDate.getFullYear();
  const month = post.data.pubDate.toLocaleDateString('en-US', { month: 'long' });
  const yearMonth = `${year}-${month}`;
  
  if (!postsByYearMonth.has(year)) {
    postsByYearMonth.set(year, new Map());
  }
  
  const yearMap = postsByYearMonth.get(year);
  if (!yearMap.has(month)) {
    yearMap.set(month, []);
  }
  
  yearMap.get(month).push(post);
});

// Convert to sorted array
const sortedYears = Array.from(postsByYearMonth.entries()).sort((a, b) => b[0] - a[0]);
---

<BaseLayout pageTitle="Archive" description="All blog posts organized by date">
	<h1>Archive</h1>
	<p>All blog posts organized by year and month.</p>
	
	<div class="archive">
		{sortedYears.map(([year, monthsMap]) => (
			<section class="year-section">
				<h2 class="year-heading">{year}</h2>
				{Array.from(monthsMap.entries()).map(([month, posts]) => (
					<div class="month-section">
						<h3 class="month-heading">{month} ({posts.length})</h3>
						<ul class="archive-list">
							{posts.map(post => (
								<li>
									<span class="post-date">
										{post.data.pubDate.toLocaleDateString('en-US', { day: 'numeric' })}
									</span>
									<a href={`/blog/${post.slug}`}>
										{post.data.title}
									</a>
								</li>
							))}
						</ul>
					</div>
				))}
			</section>
		))}
	</div>
	
	<nav class="archive-navigation">
		<a href="/blog" class="back-to-blog">&larr; Back to Blog</a>
	</nav>
</BaseLayout>

<style>
	h1 {
		margin-top: var(--spacing-2xl);
		background: var(--gradient-sunrise);
		background-clip: text;
		-webkit-background-clip: text;
		-webkit-text-fill-color: transparent;
	}

	.archive {
		margin: var(--spacing-2xl) 0;
	}

	.year-section {
		margin-bottom: var(--spacing-2xl);
	}

	.year-heading {
		font-size: var(--font-size-3xl);
		color: var(--color-text-primary);
		margin-bottom: var(--spacing-lg);
		padding-bottom: var(--spacing-sm);
		border-bottom: 2px solid var(--color-border);
		font-weight: var(--font-weight-semibold);
	}

	.month-section {
		margin-bottom: var(--spacing-xl);
	}

	.month-heading {
		font-size: var(--font-size-xl);
		color: var(--color-text-secondary);
		margin-bottom: var(--spacing-md);
		font-weight: var(--font-weight-medium);
	}

	.archive-list {
		list-style: none;
		padding: 0;
		margin: 0;
	}

	.archive-list li {
		display: flex;
		align-items: baseline;
		gap: var(--spacing-md);
		margin-bottom: var(--spacing-xs);
		padding: var(--spacing-sm) 0;
		border-bottom: 1px dotted var(--color-border);
		transition: all var(--transition-fast);
	}

	.archive-list li:hover {
		padding-left: var(--spacing-sm);
	}

	.archive-list li:last-child {
		border-bottom: none;
	}

	.post-date {
		color: var(--color-text-tertiary);
		font-size: var(--font-size-sm);
		min-width: 2rem;
		text-align: right;
		font-weight: var(--font-weight-medium);
	}

	.archive-list a {
		flex: 1;
		color: var(--color-text-primary);
		text-decoration: none;
		transition: color var(--transition-fast);
	}

	.archive-list a:hover {
		color: var(--color-primary);
	}

	.archive-navigation {
		margin-top: var(--spacing-2xl);
		padding-top: var(--spacing-xl);
		border-top: 1px solid var(--color-border);
		text-align: center;
	}

	.back-to-blog {
		color: var(--color-primary);
		font-weight: var(--font-weight-medium);
		font-size: var(--font-size-base);
		text-decoration: none;
		padding: var(--spacing-sm) var(--spacing-lg);
		border-radius: var(--radius-md);
		transition: all var(--transition-fast);
		display: inline-block;
	}

	.back-to-blog:hover {
		background: var(--color-bg-tertiary);
		text-decoration: none;
	}
</style>